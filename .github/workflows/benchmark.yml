name: Benchmark

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  benchmark:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: macos-latest
    env:
      BENCH_COUNT: 7
      BENCH_PKG: ./internal/...
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}

    steps:
      # actions/checkout@v6.0.1
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      # actions/setup-go@v6.1.0
      - uses: actions/setup-go@ae252ee6fb24babc50e89fc67c4aa608e69fbf8f
        with:
          go-version-file: go.mod

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks
        run: |
          go test -tags=perf -bench=. -benchmem -count="${BENCH_COUNT}" -run=^$ "${BENCH_PKG}" | tee "${GITHUB_WORKSPACE}/bench.txt"

      - name: Generate benchmark report
        run: |
          bench_lines=$(grep -c '^Benchmark' "${GITHUB_WORKSPACE}/bench.txt" || true)

          {
            echo "<!-- benchstat -->"
            echo "## Benchmark Results"
            echo ""
            echo "- Commit: \`${HEAD_SHA}\`"
            echo ""
          } > "${GITHUB_WORKSPACE}/benchstat_comment.md"

          {
            echo "## Benchmark Results"
            echo "- Commit: \`${HEAD_SHA}\`"
            echo ""
          } >> "${GITHUB_STEP_SUMMARY}"

          if [ "${bench_lines}" -gt 0 ]; then
            benchstat "${GITHUB_WORKSPACE}/bench.txt" > "${GITHUB_WORKSPACE}/benchstat.txt"
          else
            echo "No benchmark data to display." | tee -a "${GITHUB_WORKSPACE}/benchstat_comment.md" >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi

          {
            echo '<details>'
            echo '<summary>Benchmark Details</summary>'
            echo ''
            echo '```'
            cat "${GITHUB_WORKSPACE}/benchstat.txt"
            echo '```'
            echo '</details>'
          } | tee -a "${GITHUB_WORKSPACE}/benchstat_comment.md" >> "${GITHUB_STEP_SUMMARY}"

      - name: Comment benchmark results
        uses: actions/github-script@v8.0.0
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync(process.env.BENCHSTAT_COMMENT, 'utf8');
            const marker = '<!-- benchstat -->';
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number });
            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
        env:
          BENCHSTAT_COMMENT: ${{ github.workspace }}/benchstat_comment.md
